---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Pouch AI Dashboard">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Budget Overview Card -->
        <div class="card bg-base-100 shadow-xl border border-base-200">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-2">Current Budget</h2>
                <div class="flex items-baseline gap-1">
                    <span
                        class="text-4xl font-bold text-primary"
                        id="budget-display">--.--</span
                    >
                    <span class="text-xl text-base-content/70">USD</span>
                </div>
                <p class="text-sm text-base-content/60 mt-2">
                    Remaining balance available for requests.
                </p>
                <div class="card-actions justify-end mt-4">
                    <button
                        class="btn btn-sm btn-outline btn-primary"
                        onclick="window.location.reload()">Refresh</button
                    >
                </div>
            </div>
        </div>

        <!-- Add Funds Card -->
        <div class="card bg-base-100 shadow-xl border border-base-200">
            <div class="card-body">
                <h2 class="card-title text-xl mb-4">Add Funds</h2>
                <form id="add-funds-form" class="flex flex-col gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Amount (USD)</span>
                        </label>
                        <input
                            type="number"
                            step="0.01"
                            min="0.01"
                            name="amount"
                            placeholder="10.00"
                            class="input input-bordered w-full"
                            required
                        />
                    </div>
                    <button type="submit" class="btn btn-secondary w-full"
                        >Deposite Funds</button
                    >
                </form>
                <div
                    id="status-msg"
                    class="text-sm mt-2 text-center opacity-0 transition-opacity"
                >
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fetch budget on load
        async function fetchBudget() {
            try {
                const res = await fetch("/v1/stats/budget");
                if (!res.ok) throw new Error("Failed to fetch");
                const data = await res.json();
                const el = document.getElementById("budget-display");
                if (el) el.innerText = data.budget.toFixed(4);
            } catch (err) {
                console.error(err);
                const el = document.getElementById("budget-display");
                if (el) el.innerText = "Error";
            }
        }

        // Handle Add Funds
        const form = document.getElementById(
            "add-funds-form",
        ) as HTMLFormElement;
        const msg = document.getElementById("status-msg");

        if (form) {
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const amount = parseFloat(formData.get("amount") as string);

                if (isNaN(amount) || amount <= 0) return;

                // For simplicity, we just set the balance for now (dev mode mostly),
                // but in a real app this would ADD to it.
                // The current API is `SetBalance`. Ideally we should have `AddBalance` or read-then-write.
                // Let's first read existing, then add.
                try {
                    // 1. Get current
                    const res = await fetch("/v1/stats/budget");
                    const data = await res.json();
                    const current = data.budget || 0;

                    // 2. Set new
                    const newBalance = current + amount;
                    const updateRes = await fetch("/v1/stats/budget", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ amount: newBalance }),
                    });

                    if (updateRes.ok) {
                        fetchBudget(); // refresh display
                        if (msg) {
                            msg.innerText = `Successfully added $${amount}`;
                            msg.classList.remove("opacity-0", "text-error");
                            msg.classList.add("text-success");
                            setTimeout(
                                () => msg.classList.add("opacity-0"),
                                3000,
                            );
                        }
                        form.reset();
                    } else {
                        throw new Error("Update failed");
                    }
                } catch (err) {
                    console.error(err);
                    if (msg) {
                        msg.innerText = "Failed to update funds";
                        msg.classList.remove("opacity-0", "text-success");
                        msg.classList.add("text-error");
                    }
                }
            });
        }

        fetchBudget();
    </script>
</Layout>
