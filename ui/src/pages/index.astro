---
import Layout from "../layouts/Layout.astro";
---

<Layout title="App Keys - Pouch AI">
    <div class="max-w-7xl mx-auto py-10 px-6">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1
                    class="text-4xl font-extrabold text-base-content tracking-tight"
                >
                    App Keys
                </h1>
                <p class="text-base-content/60 mt-2 text-lg">
                    Manage API access for your applications.
                </p>
            </div>
            <label
                for="create-key-modal"
                class="btn btn-primary btn-lg shadow-lg gap-2"
                onclick="resetCreateForm()"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-6 w-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"></path></svg
                >
                Generate Key
            </label>
        </div>

        <!-- Key List (Loading State Initial) -->
        <div id="keys-loading" class="flex justify-center py-20">
            <span class="loading loading-spinner loading-lg text-primary"
            ></span>
        </div>

        <div
            id="keys-empty"
            class="hidden flex flex-col items-center justify-center py-24 bg-base-100 rounded-3xl border border-base-200 shadow-sm text-center"
        >
            <div class="bg-primary/10 p-4 rounded-full mb-4">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-12 w-12 text-primary"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"
                    ></path></svg
                >
            </div>
            <h3 class="text-2xl font-bold mb-2 text-base-content">
                No Keys Found
            </h3>
            <p class="text-base-content/60 max-w-md mx-auto mb-8">
                Get started by generating your first API key to secure and
                manage access to your LLM proxy.
            </p>
            <label
                for="create-key-modal"
                class="btn btn-outline btn-primary"
                onclick="resetCreateForm()">Generate Key</label
            >
        </div>

        <div id="keys-grid" class="hidden grid grid-cols-1 gap-6">
            <!-- Cards injected via JS -->
        </div>
    </div>

    <!-- Create Key Modal -->
    <input type="checkbox" id="create-key-modal" class="modal-toggle" />
    <div class="modal backdrop-blur-sm">
        <div
            class="modal-box w-11/12 max-w-4xl p-0 overflow-hidden bg-base-100 rounded-2xl shadow-2xl"
        >
            <div
                class="bg-base-200/50 p-6 border-b border-base-200 flex justify-between items-center"
            >
                <h3 class="font-bold text-2xl">Generate New Key</h3>
                <label
                    for="create-key-modal"
                    class="btn btn-sm btn-circle btn-ghost">✕</label
                >
            </div>

            <form id="create-key-form" class="p-8 flex flex-col gap-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left Column: Config -->
                    <div class="flex flex-col gap-5">
                        <div class="form-control">
                            <label class="label"
                                ><span class="label-text font-bold"
                                    >App Name</span
                                ></label
                            >
                            <input
                                type="text"
                                name="name"
                                placeholder="e.g. Mobile App v2"
                                class="input input-bordered w-full bg-base-200/30 focus:bg-base-100 transition-colors"
                                required
                            />
                        </div>

                        <!-- Mode Selection Cards -->
                        <div class="form-control">
                            <label class="label"
                                ><span class="label-text font-bold"
                                    >Budget Mode</span
                                ></label
                            >
                            <div class="grid grid-cols-1 gap-3">
                                <label
                                    class="cursor-pointer border border-base-300 p-4 rounded-xl hover:border-primary hover:bg-primary/5 transition-all flex gap-3 items-start relative group"
                                >
                                    <input
                                        type="radio"
                                        name="mode_type"
                                        value="prepaid"
                                        class="radio radio-primary mt-1"
                                        checked
                                        onchange="toggleModeInputs()"
                                    />
                                    <div class="flex-1">
                                        <span
                                            class="font-bold text-base block mb-1"
                                            >Prepaid (One-time)</span
                                        >
                                        <span
                                            class="text-sm opacity-70 leading-tight"
                                            >Budget depletes and stops. Great
                                            for testing or strict limits.</span
                                        >
                                    </div>
                                </label>
                                <label
                                    class="cursor-pointer border border-base-300 p-4 rounded-xl hover:border-primary hover:bg-primary/5 transition-all flex gap-3 items-start relative group"
                                >
                                    <input
                                        type="radio"
                                        name="mode_type"
                                        value="subscription"
                                        class="radio radio-success mt-1"
                                        onchange="toggleModeInputs()"
                                    />
                                    <div class="flex-1">
                                        <span
                                            class="font-bold text-base block mb-1"
                                            >Subscription (Auto-Renew)</span
                                        >
                                        <span
                                            class="text-sm opacity-70 leading-tight"
                                            >Budget resets automatically. Ideal
                                            for production services.</span
                                        >
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Expiration (Prepaid Only) / Period (Sub Only) -->
                        <div class="form-control" id="form-section-expiration">
                            <label class="label"
                                ><span class="label-text font-bold"
                                    >Key Expiration</span
                                ></label
                            >
                            <select
                                name="expiration"
                                class="select select-bordered w-full bg-base-200/30"
                            >
                                <option value="7">7 Days</option>
                                <option value="30">30 Days</option>
                                <option value="90" selected>90 Days</option>
                                <option value="365">1 Year</option>
                                <option value="0">Never</option>
                            </select>
                        </div>

                        <div
                            class="form-control hidden"
                            id="form-section-period"
                        >
                            <label class="label"
                                ><span class="label-text font-bold"
                                    >Renewal Period</span
                                ></label
                            >
                            <select
                                name="budget_period"
                                class="select select-bordered w-full bg-base-200/30"
                            >
                                <option value="monthly" selected
                                    >Monthly Reset</option
                                >
                                <option value="weekly">Weekly Reset</option>
                            </select>
                        </div>

                        <div class="form-control">
                            <label class="label"
                                ><span class="label-text font-bold"
                                    >Budget Limit</span
                                ></label
                            >
                            <div class="relative">
                                <span
                                    class="absolute left-4 top-1/2 -translate-y-1/2 opacity-50"
                                    >$</span
                                >
                                <input
                                    type="number"
                                    name="budget_limit"
                                    value="5.00"
                                    step="0.01"
                                    min="0"
                                    class="input input-bordered w-full pl-8 font-mono text-lg bg-base-200/30"
                                />
                            </div>
                            <label class="label"
                                ><span class="label-text-alt"
                                    >0 = Unlimited</span
                                ></label
                            >
                        </div>
                    </div>

                    <!-- Right Column: Type & Mock -->
                    <div
                        class="flex flex-col gap-5 border-l border-base-200 lg:pl-8"
                    >
                        <div class="form-control">
                            <label class="label"
                                ><span class="label-text font-bold"
                                    >Key Type</span
                                ></label
                            >
                            <label
                                class="label cursor-pointer justify-start gap-4 bg-base-200/30 p-4 rounded-lg"
                            >
                                <input
                                    type="checkbox"
                                    class="toggle toggle-primary"
                                    id="mock-toggle"
                                    name="is_mock"
                                    onchange="toggleMockSection()"
                                />
                                <div>
                                    <span class="label-text font-bold block"
                                        >Mock / Dummy Mode</span
                                    >
                                    <span class="text-xs opacity-70"
                                        >Returns static JSON response. No tokens
                                        are charged.</span
                                    >
                                </div>
                            </label>
                        </div>

                        <!-- Mock Editor -->
                        <div
                            id="mock-config-section"
                            class="hidden flex-1 flex flex-col"
                        >
                            <label class="label"
                                ><span class="label-text font-bold"
                                    >Response JSON</span
                                ></label
                            >
                            <textarea
                                name="mock_config"
                                class="textarea textarea-bordered font-mono text-xs leading-relaxed flex-1 w-full bg-base-300/30 min-h-[200px]"
                                placeholder='{"choices":[{"message":{"content":"Hello"}}]}'
                                >{
                                    `{"choices":[{"message":{"content":"Hello from Mock!", "role": "assistant"}}]}`
                                }</textarea
                            >
                        </div>
                    </div>
                </div>

                <div class="modal-action border-t border-base-200 pt-6 mt-2">
                    <label
                        for="create-key-modal"
                        class="btn btn-ghost px-8"
                        id="close-modal-btn">Cancel</label
                    >
                    <button type="submit" class="btn btn-primary px-8"
                        >Generate Key</button
                    >
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Key Modal -->
    <input type="checkbox" id="edit-key-modal" class="modal-toggle" />
    <div class="modal backdrop-blur-sm">
        <div
            class="modal-box w-11/12 max-w-2xl bg-base-100 rounded-2xl shadow-2xl"
        >
            <h3 class="font-bold text-2xl mb-6">Edit Key</h3>
            <input type="hidden" id="edit-key-id" />

            <form id="edit-key-form" class="flex flex-col gap-4">
                <div class="form-control">
                    <label class="label"
                        ><span class="label-text font-bold">App Name</span
                        ></label
                    >
                    <input
                        type="text"
                        id="edit-key-name"
                        class="input input-bordered w-full"
                        required
                    />
                </div>

                <div class="form-control">
                    <label class="label"
                        ><span class="label-text font-bold"
                            >Budget Limit (USD)</span
                        ></label
                    >
                    <div class="relative">
                        <span
                            class="absolute left-4 top-1/2 -translate-y-1/2 opacity-50"
                            >$</span
                        >
                        <input
                            type="number"
                            id="edit-key-limit"
                            step="0.01"
                            min="0"
                            class="input input-bordered w-full pl-8 font-mono"
                        />
                    </div>
                </div>

                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-4">
                        <span class="label-text font-bold">Mock Mode</span>
                        <input
                            type="checkbox"
                            id="edit-key-is-mock"
                            class="toggle toggle-primary"
                            onchange="toggleEditMock()"
                        />
                    </label>
                </div>

                <div id="edit-mock-section" class="form-control hidden">
                    <label class="label"
                        ><span class="label-text font-bold"
                            >Mock Response (JSON)</span
                        ></label
                    >
                    <textarea
                        id="edit-key-mock-config"
                        class="textarea textarea-bordered font-mono h-32"
                    ></textarea>
                </div>

                <div class="alert alert-warning shadow-sm mt-4">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="stroke-current shrink-0 h-6 w-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                        ></path></svg
                    >
                    <span class="text-sm"
                        >Type, Expiration, and Renewal Period cannot be changed
                        to ensure consistency.</span
                    >
                </div>

                <div class="modal-action">
                    <label
                        for="edit-key-modal"
                        class="btn btn-ghost"
                        id="close-edit-modal">Cancel</label
                    >
                    <button type="submit" class="btn btn-primary"
                        >Save Changes</button
                    >
                </div>
            </form>
        </div>
    </div>

    <!-- New Key Display Modal is same -->
    <input type="checkbox" id="new-key-display-modal" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box relative">
            <h3 class="font-bold text-lg text-success">Key Generated!</h3>
            <p class="py-4">
                Please copy your API key now.<br /><span
                    class="font-bold text-error"
                    >It will not be shown again.</span
                >
            </p>
            <div
                class="bg-base-200 p-4 rounded-lg flex justify-between items-center"
            >
                <code
                    id="new-key-value"
                    class="break-all font-mono font-bold text-lg"
                    >pk-xxxxxxxx</code
                >
                <button class="btn btn-sm btn-ghost" onclick="copyKey()"
                    >Copy</button
                >
            </div>
            <div class="modal-action">
                <label
                    for="new-key-display-modal"
                    class="btn"
                    onclick="window.location.reload()">Done</label
                >
            </div>
        </div>
    </div>

    <script>
        // --- UI Logic ---
        (window as any).toggleModeInputs = () => {
            const mode = (
                document.querySelector(
                    'input[name="mode_type"]:checked',
                ) as HTMLInputElement
            )?.value;
            const expSection = document.getElementById(
                "form-section-expiration",
            );
            const periodSection = document.getElementById(
                "form-section-period",
            );

            if (mode === "subscription") {
                expSection?.classList.add("hidden");
                periodSection?.classList.remove("hidden");
            } else {
                expSection?.classList.remove("hidden");
                periodSection?.classList.add("hidden");
            }
        };

        (window as any).toggleMockSection = () => {
            const check = (
                document.getElementById("mock-toggle") as HTMLInputElement
            ).checked;
            const section = document.getElementById("mock-config-section");
            if (check) {
                section?.classList.remove("hidden");
            } else {
                section?.classList.add("hidden");
            }
        };

        (window as any).toggleEditMock = () => {
            const check = (
                document.getElementById("edit-key-is-mock") as HTMLInputElement
            ).checked;
            const section = document.getElementById("edit-mock-section");
            if (check) section?.classList.remove("hidden");
            else section?.classList.add("hidden");
        };

        (window as any).resetCreateForm = () => {
            (
                document.getElementById("create-key-form") as HTMLFormElement
            ).reset();
            const mockToggle = document.getElementById(
                "mock-toggle",
            ) as HTMLInputElement;
            if (mockToggle) mockToggle.checked = false;
            (window as any).toggleMockSection();
            (window as any).toggleModeInputs();
        };

        // --- Settings Logic ---
        async function loadSettings() {
            try {
                const res = await fetch("/v1/config/settings", {
                    cache: "no-store",
                });
                const data = await res.json();

                const statusEl = document.getElementById("api-key-status");
                if (statusEl) {
                    statusEl.textContent = data.api_key_set
                        ? "✓ API Key is configured"
                        : "⚠ No API Key set";
                    statusEl.classList.toggle("text-success", data.api_key_set);
                    statusEl.classList.toggle(
                        "text-warning",
                        !data.api_key_set,
                    );
                }

                const throttleEl = document.getElementById(
                    "settings-throttle",
                ) as HTMLInputElement;
                if (throttleEl) throttleEl.value = data.throttle_rate || 100;
            } catch (e) {
                console.error("Failed to load settings", e);
            }
        }

        (window as any).saveApiKey = async () => {
            const input = document.getElementById(
                "settings-api-key",
            ) as HTMLInputElement;
            const key = input.value.trim();
            if (!key) {
                alert("Please enter an API key");
                return;
            }

            const res = await fetch("/v1/config/key", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ provider: "openai", key }),
            });

            if (res.ok) {
                input.value = "";
                alert("API Key saved successfully!");
                loadSettings();
            } else {
                alert("Failed to save API Key");
            }
        };

        (window as any).saveThrottle = async () => {
            const input = document.getElementById(
                "settings-throttle",
            ) as HTMLInputElement;
            const rate = parseInt(input.value) || 100;

            const res = await fetch("/v1/config/settings", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ throttle_rate: rate }),
            });

            if (res.ok) {
                alert("Throttle rate saved! Restart server to apply.");
            } else {
                alert("Failed to save throttle rate");
            }
        };

        // --- Data Logic ---
        let currentKeys: any[] = [];

        async function loadKeys() {
            const grid = document.getElementById("keys-grid");
            const loading = document.getElementById("keys-loading");
            const empty = document.getElementById("keys-empty");

            try {
                const res = await fetch("/v1/config/app-keys", {
                    cache: "no-store",
                });
                const keys = (await res.json()) || [];
                currentKeys = keys;

                loading?.classList.add("hidden");

                if (keys.length === 0) {
                    empty?.classList.remove("hidden");
                    grid?.classList.add("hidden");
                    return;
                }

                empty?.classList.add("hidden");
                grid?.classList.remove("hidden");
                grid!.innerHTML = "";

                keys.forEach((key: any) => {
                    // Logic for display
                    let expiresText = "Never";
                    let isExpired = false;
                    let modeBadge = "";
                    let statusBadge = `<span class="badge badge-success badge-sm gap-1 pl-1 pr-2 py-3"><div class="w-2 h-2 rounded-full bg-white"></div>Active</span>`;

                    // Expiration Logic
                    if (key.expires_at) {
                        const expDate = new Date(key.expires_at * 1000);
                        expiresText = expDate.toLocaleDateString();
                        if (expDate < new Date()) {
                            isExpired = true;
                            statusBadge = `<span class="badge badge-error badge-sm gap-1 py-3">Expired</span>`;
                        }
                    }

                    // Mode Badge
                    if (key.budget_period && key.budget_period !== "none") {
                        modeBadge = `<span class="badge badge-outline badge-secondary badge-sm capitalize">${key.budget_period} Sub</span>`;
                    } else {
                        modeBadge = `<span class="badge badge-outline badge-primary badge-sm">Prepaid</span>`;
                    }

                    // Mock Badge
                    if (key.is_mock) {
                        statusBadge = `<span class="badge badge-info badge-sm gap-1 py-3 font-bold">MOCK MODE</span>`;
                    }

                    // Budget Logic
                    const limit = key.budget_limit;
                    const usage = key.budget_usage;
                    let usagePercent = 0;
                    let barColor = "progress-primary";

                    if (limit > 0) {
                        usagePercent = Math.min((usage / limit) * 100, 100);
                        if (usagePercent > 80) barColor = "progress-warning";
                        if (usagePercent >= 100) {
                            barColor = "progress-error";
                            if (!key.is_mock)
                                statusBadge = `<span class="badge badge-error badge-sm gap-1 py-3">Depleted</span>`;
                        }
                    }

                    // Render Card
                    const card = document.createElement("div");
                    card.className =
                        "card bg-base-100 shadow-sm border border-base-200 hover:shadow-md transition-shadow group";
                    card.innerHTML = `
            <div class="card-body p-6">
               <div class="flex justify-between items-start mb-2">
                   <div>
                       <div class="flex items-center gap-2 mb-1">
                           <h2 class="card-title text-xl font-bold">${key.name}</h2>
                           ${statusBadge}
                       </div>
                       <p class="font-mono text-xs opacity-50 bg-base-200 inline-block px-2 py-1 rounded">${key.prefix}</p>
                   </div>
                   <div class="flex flex-col items-end gap-1">
                       ${modeBadge}
                       <span class="text-xs opacity-50">Created ${new Date(key.created_at * 1000).toLocaleDateString()}</span>
                   </div>
               </div>
               
               <div class="divider my-2"></div>
               
               <div class="grid grid-cols-2 gap-4 text-sm mt-2">
                   <div>
                       <div class="opacity-60 mb-1 flex justify-between">
                           <span>Budget Usage</span>
                           <span class="font-bold text-base-content">$${usage.toFixed(4)} / ${limit > 0 ? "$" + limit.toFixed(2) : "∞"}</span>
                       </div>
                       <progress class="progress ${barColor} w-full h-2 bg-base-200" value="${usagePercent}" max="100"></progress>
                       ${key.budget_period && key.budget_period !== "none" ? `<div class="text-xs opacity-50 mt-1">Resets ${key.budget_period}</div>` : ""}
                   </div>
                   <div class="text-right flex flex-col justify-center">
                       <span class="opacity-60 block">Key Expiration</span>
                       <span class="font-medium ${isExpired ? "text-error" : ""}">${expiresText}</span>
                   </div>
               </div>

               <div class="card-actions justify-end mt-6 opacity-0 group-hover:opacity-100 transition-opacity">
                   <button class="btn btn-sm btn-ghost" onclick="openEdit(${key.id})">Edit</button>
                   <button class="btn btn-sm btn-outline btn-error" onclick="revokeKey(${key.id})">Revoke</button>
               </div>
            </div>
          `;
                    grid?.appendChild(card);
                });
            } catch (err) {
                console.error(err);
            }
        }

        // --- Actions ---
        (window as any).copyKey = () => {
            const el = document.getElementById("new-key-value");
            if (el) navigator.clipboard.writeText(el.innerText);
        };

        (window as any).revokeKey = async (id: number) => {
            if (!confirm("Are you sure? This cannot be undone.")) return;
            await fetch(`/v1/config/app-keys/${id}`, { method: "DELETE" });
            loadKeys();
        };

        (window as any).openEdit = (id: number) => {
            const key = currentKeys.find((k) => k.id === id);
            if (!key) return;

            (document.getElementById("edit-key-id") as HTMLInputElement).value =
                id.toString();
            (
                document.getElementById("edit-key-name") as HTMLInputElement
            ).value = key.name;
            (
                document.getElementById("edit-key-limit") as HTMLInputElement
            ).value = key.budget_limit.toString();
            (
                document.getElementById("edit-key-is-mock") as HTMLInputElement
            ).checked = key.is_mock;
            (
                document.getElementById(
                    "edit-key-mock-config",
                ) as HTMLTextAreaElement
            ).value = key.mock_config || '{"choices":[]}';

            (window as any).toggleEditMock();

            (
                document.getElementById("edit-key-modal") as HTMLInputElement
            ).checked = true;
        };

        // CREATE
        const createForm = document.getElementById("create-key-form");
        createForm?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const fd = new FormData(createForm as HTMLFormElement);

            const mode = fd.get("mode_type");
            const days = parseInt(fd.get("expiration") as string);
            let expires_at = null;
            let period = "none";

            if (mode === "prepaid") {
                if (days > 0)
                    expires_at = Math.floor(Date.now() / 1000) + days * 86400;
            } else {
                period = fd.get("budget_period") as string;
            }

            const payload = {
                name: fd.get("name"),
                expires_at,
                budget_limit: parseFloat(fd.get("budget_limit") as string),
                budget_period: period,
                is_mock: (
                    document.getElementById("mock-toggle") as HTMLInputElement
                ).checked,
                mock_config: fd.get("mock_config"),
            };

            const res = await fetch("/v1/config/app-keys", {
                method: "POST",
                body: JSON.stringify(payload),
                headers: { "Content-Type": "application/json" },
            });

            if (res.ok) {
                const data = await res.json();
                (
                    document.getElementById(
                        "create-key-modal",
                    ) as HTMLInputElement
                ).checked = false;
                (
                    document.getElementById("new-key-value") as HTMLElement
                ).innerText = data.key;
                (
                    document.getElementById(
                        "new-key-display-modal",
                    ) as HTMLInputElement
                ).checked = true;
            } else {
                alert("Failed to create key");
            }
        });

        // UPDATE
        const editForm = document.getElementById("edit-key-form");
        editForm?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = (
                document.getElementById("edit-key-id") as HTMLInputElement
            ).value;

            const payload = {
                name: (
                    document.getElementById("edit-key-name") as HTMLInputElement
                ).value,
                budget_limit: parseFloat(
                    (
                        document.getElementById(
                            "edit-key-limit",
                        ) as HTMLInputElement
                    ).value,
                ),
                is_mock: (
                    document.getElementById(
                        "edit-key-is-mock",
                    ) as HTMLInputElement
                ).checked,
                mock_config: (
                    document.getElementById(
                        "edit-key-mock-config",
                    ) as HTMLTextAreaElement
                ).value,
            };

            const res = await fetch(`/v1/config/app-keys/${id}`, {
                method: "PUT",
                body: JSON.stringify(payload),
                headers: { "Content-Type": "application/json" },
            });

            if (res.ok) {
                (
                    document.getElementById(
                        "edit-key-modal",
                    ) as HTMLInputElement
                ).checked = false;
                loadKeys();
            } else {
                alert("Failed to update key");
            }
        });

        loadKeys();
    </script>
</Layout>
