---
import Layout from "../layouts/Layout.astro";
---

<Layout title="API Keys - Pouch AI">
    <div class="max-w-5xl mx-auto py-12 px-6">
        <!-- Header -->
        <div
            class="flex flex-col sm:flex-row sm:justify-between sm:items-end gap-6 mb-10"
        >
            <div>
                <h1 class="text-3xl font-bold text-base-content">API Keys</h1>
                <p class="text-base-content/50 mt-2">
                    Create and manage API keys for your applications.
                </p>
            </div>
            <label
                for="create-key-modal"
                class="btn btn-primary shadow-lg shadow-primary/20 gap-2 group"
                onclick="resetCreateForm()"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 transition-transform group-hover:rotate-90"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"></path></svg
                >
                Create Key
            </label>
        </div>

        <!-- Loading State -->
        <div
            id="keys-loading"
            class="flex flex-col items-center justify-center py-24"
        >
            <span class="loading loading-spinner loading-lg text-primary"
            ></span>
            <p class="text-base-content/50 mt-4 text-sm">Loading keys...</p>
        </div>

        <!-- Empty State -->
        <div
            id="keys-empty"
            class="hidden flex flex-col items-center justify-center py-20 bg-base-100/30 backdrop-blur-sm rounded-2xl border border-base-content/5 text-center"
        >
            <div
                class="w-16 h-16 rounded-2xl bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center mb-6"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-8 w-8 text-primary"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"
                    ></path></svg
                >
            </div>
            <h3 class="text-xl font-semibold mb-2 text-base-content">
                No API Keys Yet
            </h3>
            <p class="text-base-content/50 max-w-sm mx-auto mb-8 text-sm">
                Create your first API key to start managing access and budgets
                for your AI applications.
            </p>
            <label
                for="create-key-modal"
                class="btn btn-primary btn-sm gap-2"
                onclick="resetCreateForm()"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"></path></svg
                >
                Create Your First Key
            </label>
        </div>

        <!-- Keys Grid -->
        <div id="keys-grid" class="hidden flex flex-col gap-4">
            <!-- Cards injected via JS -->
        </div>
    </div>

    <!-- Create Key Modal -->
    <input type="checkbox" id="create-key-modal" class="modal-toggle" />
    <div class="modal backdrop-blur-md">
        <div
            class="modal-box w-11/12 max-w-4xl p-0 overflow-hidden bg-base-100/95 backdrop-blur-xl border border-base-content/5 rounded-2xl shadow-2xl"
        >
            <div
                class="p-6 border-b border-base-content/5 flex justify-between items-center bg-base-200/50"
            >
                <div>
                    <h3 class="font-bold text-2xl">Create API Key</h3>
                    <p class="text-sm text-base-content/50 mt-1">
                        Configure model access and usage policies
                    </p>
                </div>
                <label
                    for="create-key-modal"
                    class="btn btn-sm btn-circle btn-ghost text-base-content/50 hover:text-base-content"
                    >âœ•</label
                >
            </div>

            <form id="create-key-form" class="p-8 flex flex-col gap-8">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                    <!-- Left Section: Basic Info & Provider -->
                    <div class="flex flex-col gap-6">
                        <h4
                            class="text-xs font-bold uppercase tracking-wider text-primary/70"
                        >
                            General Settings
                        </h4>

                        <div class="form-control">
                            <label class="label"
                                ><span
                                    class="label-text font-bold text-base-content/80"
                                    >Key Name</span
                                ></label
                            >
                            <input
                                type="text"
                                name="name"
                                placeholder="e.g. Mobile App v2"
                                class="input input-bordered w-full bg-base-200/50 focus:bg-base-100 border-base-content/10 transition-all font-medium"
                                required
                            />
                        </div>

                        <div class="form-control">
                            <label class="label"
                                ><span
                                    class="label-text font-bold text-base-content/80"
                                    >LLM Provider</span
                                ></label
                            >
                            <div class="grid grid-cols-1 gap-2">
                                <label
                                    class="flex items-center gap-3 p-3 rounded-xl border border-primary bg-primary/5 cursor-pointer transition-all"
                                >
                                    <input
                                        type="radio"
                                        name="provider"
                                        value="openai"
                                        class="radio radio-primary radio-sm"
                                        checked
                                    />
                                    <div class="flex items-center gap-2">
                                        <img
                                            src="https://simpleicons.org/icons/openai.svg"
                                            class="w-4 h-4 dark:invert"
                                        />
                                        <span class="font-semibold text-sm"
                                            >OpenAI</span
                                        >
                                    </div>
                                </label>
                                <label
                                    class="flex items-center gap-3 p-3 rounded-xl border border-base-content/10 hover:border-primary/50 opacity-50 cursor-not-allowed"
                                >
                                    <input
                                        type="radio"
                                        name="provider"
                                        value="anthropic"
                                        class="radio radio-primary radio-sm"
                                        disabled
                                    />
                                    <div class="flex items-center gap-2">
                                        <span class="font-semibold text-sm"
                                            >Anthropic (Coming Soon)</span
                                        >
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="form-control">
                            <label class="label"
                                ><span
                                    class="label-text font-bold text-base-content/80"
                                    >Mock Mode</span
                                ></label
                            >
                            <label
                                class="flex items-center justify-between p-3 rounded-xl bg-base-200/50 border border-base-content/5 cursor-pointer"
                            >
                                <div>
                                    <span class="text-sm font-medium"
                                        >Simulated Response</span
                                    >
                                    <p class="text-[10px] opacity-50">
                                        Free & fast. No external calls.
                                    </p>
                                </div>
                                <input
                                    type="checkbox"
                                    name="is_mock"
                                    id="mock-toggle"
                                    class="toggle toggle-primary toggle-sm"
                                    onchange="toggleMockSection()"
                                />
                            </label>
                        </div>
                    </div>

                    <!-- Middle Section: Budget & Limits -->
                    <div class="flex flex-col gap-6">
                        <h4
                            class="text-xs font-bold uppercase tracking-wider text-primary/70"
                        >
                            Budget & Limits
                        </h4>

                        <div class="form-control">
                            <label class="label"
                                ><span
                                    class="label-text font-bold text-base-content/80"
                                    >Budget Type</span
                                ></label
                            >
                            <div class="join w-full">
                                <input
                                    class="join-item btn btn-sm flex-1"
                                    type="radio"
                                    name="mode_type"
                                    value="prepaid"
                                    aria-label="One-time"
                                    checked
                                    onchange="toggleModeInputs()"
                                />
                                <input
                                    class="join-item btn btn-sm flex-1"
                                    type="radio"
                                    name="mode_type"
                                    value="subscription"
                                    aria-label="Recurring"
                                    onchange="toggleModeInputs()"
                                />
                            </div>
                        </div>

                        <div class="form-control">
                            <label class="label"
                                ><span
                                    class="label-text font-bold text-base-content/80"
                                    >Amount ($ USD)</span
                                ></label
                            >
                            <input
                                type="number"
                                name="budget_limit"
                                value="5.00"
                                step="0.01"
                                min="0"
                                class="input input-bordered w-full font-mono text-center bg-base-200/50 text-xl font-bold"
                            />
                        </div>

                        <div class="form-control" id="form-section-expiration">
                            <label class="label"
                                ><span
                                    class="label-text font-bold text-base-content/80"
                                    >Auto Expire</span
                                ></label
                            >
                            <select
                                name="expiration"
                                class="select select-bordered w-full bg-base-200/50 text-sm"
                            >
                                <option value="7">7 Days</option>
                                <option value="30">30 Days</option>
                                <option value="90" selected>90 Days</option>
                                <option value="365">1 Year</option>
                                <option value="0">Never</option>
                            </select>
                        </div>

                        <div
                            class="form-control hidden"
                            id="form-section-period"
                        >
                            <label class="label"
                                ><span
                                    class="label-text font-bold text-base-content/80"
                                    >Reset Frequency</span
                                ></label
                            >
                            <select
                                name="budget_period"
                                class="select select-bordered w-full bg-base-200/50 text-sm"
                            >
                                <option value="monthly" selected
                                    >Every Month</option
                                >
                                <option value="weekly">Every Week</option>
                            </select>
                        </div>
                    </div>

                    <!-- Right Section: Safety & Mock Editor -->
                    <div class="flex flex-col gap-6">
                        <h4
                            class="text-xs font-bold uppercase tracking-wider text-primary/70"
                        >
                            Safety & Mocking
                        </h4>

                        <div class="form-control">
                            <label class="label"
                                ><span
                                    class="label-text font-bold text-base-content/80"
                                    >ðŸš¦ Rate Limit</span
                                ></label
                            >
                            <div class="flex gap-2">
                                <input
                                    type="number"
                                    name="rate_limit"
                                    value="10"
                                    min="0"
                                    class="input input-bordered flex-1 bg-base-200/50 font-mono text-center"
                                />
                                <select
                                    name="rate_period"
                                    class="select select-bordered bg-base-200/50 text-xs"
                                >
                                    <option value="minute" selected
                                        >/ min</option
                                    >
                                    <option value="second">/ sec</option>
                                    <option value="none">None</option>
                                </select>
                            </div>
                        </div>

                        <div
                            id="mock-config-section"
                            class="hidden flex-1 flex flex-col"
                        >
                            <label class="label"
                                ><span
                                    class="label-text font-bold text-base-content/80"
                                    >Mock Response JSON</span
                                ></label
                            >
                            <textarea
                                name="mock_config"
                                class="textarea textarea-bordered font-mono text-[10px] leading-tight flex-1 w-full bg-base-300/50 border-base-content/5 min-h-[160px] resize-none"
                                >{
                                    `{"choices":[{"message":{"content":"Hello from Mock!", "role":"assistant"}}]}`
                                }</textarea
                            >
                        </div>

                        <div
                            id="mock-placeholder"
                            class="flex-1 flex flex-col items-center justify-center p-6 border-2 border-dashed border-base-content/10 rounded-2xl opacity-40"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-8 w-8 mb-2"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="1.5"
                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"
                                ></path>
                            </svg>
                            <span class="text-[10px] font-bold"
                                >MOCK CONFIG INACTIVE</span
                            >
                        </div>
                    </div>
                </div>

                <div
                    class="flex justify-end gap-3 pt-6 border-t border-base-content/5"
                >
                    <label for="create-key-modal" class="btn btn-ghost"
                        >Cancel</label
                    >
                    <button type="submit" class="btn btn-primary px-12"
                        >Generate Access Key</button
                    >
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Key Modal -->
    <input type="checkbox" id="edit-key-modal" class="modal-toggle" />
    <div class="modal backdrop-blur-md">
        <div
            class="modal-box w-11/12 max-w-2xl bg-base-100/95 backdrop-blur-xl border border-base-content/5 rounded-2xl shadow-2xl p-0 overflow-hidden"
        >
            <div
                class="p-6 border-b border-base-content/5 bg-base-200/50 flex justify-between items-center"
            >
                <h3 class="font-bold text-xl">Edit Access Key</h3>
                <label
                    for="edit-key-modal"
                    class="btn btn-sm btn-circle btn-ghost text-base-content/50"
                    >âœ•</label
                >
            </div>

            <input type="hidden" id="edit-key-id" />

            <form id="edit-key-form" class="p-6 flex flex-col gap-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-control">
                        <label class="label"
                            ><span
                                class="label-text font-bold text-base-content/80"
                                >Key Name</span
                            ></label
                        >
                        <input
                            type="text"
                            id="edit-key-name"
                            class="input input-bordered w-full bg-base-200/50"
                            required
                        />
                    </div>

                    <div class="form-control">
                        <label class="label"
                            ><span
                                class="label-text font-bold text-base-content/80"
                                >LLM Provider</span
                            ></label
                        >
                        <select
                            id="edit-key-provider"
                            class="select select-bordered w-full bg-base-200/50"
                        >
                            <option value="openai">OpenAI</option>
                            <option value="anthropic" disabled
                                >Anthropic (Coming Soon)</option
                            >
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label"
                            ><span
                                class="label-text font-bold text-base-content/80"
                                >Budget Limit ($)</span
                            ></label
                        >
                        <input
                            type="number"
                            id="edit-key-limit"
                            step="0.01"
                            min="0"
                            class="input input-bordered w-full bg-base-200/50 font-mono"
                        />
                    </div>

                    <div class="form-control">
                        <label class="label"
                            ><span
                                class="label-text font-bold text-base-content/80"
                                >ðŸš¦ Rate Limit</span
                            ></label
                        >
                        <div class="flex gap-2">
                            <input
                                type="number"
                                id="edit-key-rate-limit"
                                min="0"
                                class="input input-bordered flex-1 bg-base-200/50 font-mono"
                            />
                            <select
                                id="edit-key-rate-period"
                                class="select select-bordered bg-base-200/50 text-xs"
                            >
                                <option value="minute">/ min</option>
                                <option value="second">/ sec</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div
                    class="form-control p-4 rounded-xl bg-base-200/50 border border-base-content/5"
                >
                    <label class="label cursor-pointer justify-between p-0">
                        <div class="flex flex-col">
                            <span class="font-bold text-sm"
                                >Active Mock Mode</span
                            >
                            <span class="text-[10px] opacity-50"
                                >Returns static JSON instead of calling API</span
                            >
                        </div>
                        <input
                            type="checkbox"
                            id="edit-key-is-mock"
                            class="toggle toggle-primary toggle-sm"
                            onchange="toggleEditMock()"
                        />
                    </label>
                    <div
                        id="edit-mock-editor"
                        class="mt-4 hidden animate-in fade-in slide-in-from-top-2"
                    >
                        <textarea
                            id="edit-key-mock-config"
                            class="textarea textarea-bordered w-full h-32 font-mono text-[10px] bg-base-300/50"
                        ></textarea>
                    </div>
                </div>

                <div
                    class="flex justify-end gap-3 pt-4 border-t border-base-content/5"
                >
                    <label for="edit-key-modal" class="btn btn-ghost"
                        >Cancel</label
                    >
                    <button type="submit" class="btn btn-primary px-10"
                        >Save Changes</button
                    >
                </div>
            </form>
        </div>
    </div>

    <div id="edit-mock-section" class="form-control hidden">
        <label class="label"
            ><span class="label-text font-bold">Mock Response (JSON)</span
            ></label
        >
        <textarea
            id="edit-key-mock-config"
            class="textarea textarea-bordered font-mono h-32"></textarea>
    </div>

    <div class="alert alert-warning shadow-sm mt-4">
        <svg
            xmlns="http://www.w3.org/2000/svg"
            class="stroke-current shrink-0 h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
            ></path></svg
        >
        <span class="text-sm"
            >Type, Expiration, and Renewal Period cannot be changed to ensure
            consistency.</span
        >
    </div>

    <div class="modal-action">
        <label for="edit-key-modal" class="btn btn-ghost" id="close-edit-modal"
            >Cancel</label
        >
        <button type="submit" class="btn btn-primary">Save Changes</button>
    </div>
</Layout>

<!-- New Key Display Modal is same -->
<input type="checkbox" id="new-key-display-modal" class="modal-toggle" />
<div class="modal">
    <div class="modal-box relative">
        <h3 class="font-bold text-lg text-success">Key Generated!</h3>
        <p class="py-4">
            Please copy your API key now.<br /><span
                class="font-bold text-error">It will not be shown again.</span
            >
        </p>
        <div
            class="bg-base-200 p-4 rounded-lg flex justify-between items-center"
        >
            <code
                id="new-key-value"
                class="break-all font-mono font-bold text-lg">pk-xxxxxxxx</code
            >
            <button class="btn btn-sm btn-ghost" onclick="copyKey()"
                >Copy</button
            >
        </div>
        <div class="modal-action">
            <label
                for="new-key-display-modal"
                class="btn"
                onclick="window.location.reload()">Done</label
            >
        </div>
    </div>
</div>

<script>
    // --- UI Logic ---
    (window as any).toggleModeInputs = () => {
        const mode = (
            document.querySelector(
                'input[name="mode_type"]:checked',
            ) as HTMLInputElement
        )?.value;
        const expSection = document.getElementById("form-section-expiration");
        const periodSection = document.getElementById("form-section-period");

        if (mode === "subscription") {
            expSection?.classList.add("hidden");
            periodSection?.classList.remove("hidden");
        } else {
            expSection?.classList.remove("hidden");
            periodSection?.classList.add("hidden");
        }
    };

    (window as any).toggleMockSection = () => {
        const check = (
            document.getElementById("mock-toggle") as HTMLInputElement
        ).checked;
        const section = document.getElementById("mock-config-section");
        const placeholder = document.getElementById("mock-placeholder");
        if (check) {
            section?.classList.remove("hidden");
            placeholder?.classList.add("hidden");
        } else {
            section?.classList.add("hidden");
            placeholder?.classList.remove("hidden");
        }
    };

    (window as any).toggleEditMock = () => {
        const check = (
            document.getElementById("edit-key-is-mock") as HTMLInputElement
        ).checked;
        const section = document.getElementById("edit-mock-editor");
        if (check) section?.classList.remove("hidden");
        else section?.classList.add("hidden");
    };

    (window as any).resetCreateForm = () => {
        (document.getElementById("create-key-form") as HTMLFormElement).reset();
        const mockToggle = document.getElementById(
            "mock-toggle",
        ) as HTMLInputElement;
        if (mockToggle) mockToggle.checked = false;

        // Reset provider radio
        const openaiRadio = document.querySelector(
            'input[name="provider"][value="openai"]',
        ) as HTMLInputElement;
        if (openaiRadio) openaiRadio.checked = true;

        (window as any).toggleMockSection();
        (window as any).toggleModeInputs();
    };

    // --- Data Logic ---
    let currentKeys: any[] = [];

    async function loadKeys() {
        const grid = document.getElementById("keys-grid");
        const loading = document.getElementById("keys-loading");
        const empty = document.getElementById("keys-empty");

        try {
            const res = await fetch("/v1/config/app-keys", {
                cache: "no-store",
            });
            const keys = (await res.json()) || [];
            currentKeys = keys;

            loading?.classList.add("hidden");

            if (keys.length === 0) {
                empty?.classList.remove("hidden");
                grid?.classList.add("hidden");
                return;
            }

            empty?.classList.add("hidden");
            grid?.classList.remove("hidden");
            grid!.innerHTML = "";

            keys.forEach((key: any) => {
                // Logic for display
                let expiresText = "Never";
                let isExpired = false;
                let modeBadge = "";
                let statusBadge = `<span class="badge badge-success badge-sm gap-1 pl-1.5 pr-2.5 py-2.5 font-medium"><div class="w-1.5 h-1.5 rounded-full bg-white animate-pulse"></div>Active</span>`;

                // Expiration Logic
                if (key.expires_at) {
                    const expDate = new Date(key.expires_at * 1000);
                    expiresText = expDate.toLocaleDateString();
                    if (expDate < new Date()) {
                        isExpired = true;
                        statusBadge = `<span class="badge badge-error badge-sm py-2.5 font-medium">Expired</span>`;
                    }
                }

                // Mode Badge
                if (key.budget_period && key.budget_period !== "none") {
                    modeBadge = `<span class="badge badge-secondary/20 text-secondary badge-sm capitalize font-medium">${key.budget_period}</span>`;
                } else {
                    modeBadge = `<span class="badge badge-primary/20 text-primary badge-sm font-medium">Prepaid</span>`;
                }

                // Mock Badge
                if (key.is_mock) {
                    statusBadge = `<span class="badge badge-info badge-sm py-2.5 font-bold">MOCK</span>`;
                }

                // Rate limit display
                let rateLimitText = "Unlimited";
                if (key.rate_period !== "none" && key.rate_limit > 0) {
                    rateLimitText = `${key.rate_limit}/${key.rate_period === "second" ? "sec" : "min"}`;
                }

                // Budget Logic
                const limit = key.budget_limit;
                const usage = key.budget_usage;
                let usagePercent = 0;
                let barColor = "bg-primary";

                if (limit > 0) {
                    usagePercent = Math.min((usage / limit) * 100, 100);
                    if (usagePercent > 80) barColor = "bg-warning";
                    if (usagePercent >= 100) {
                        barColor = "bg-error";
                        if (!key.is_mock)
                            statusBadge = `<span class="badge badge-error badge-sm py-2.5 font-medium">Depleted</span>`;
                    }
                }

                // Render Card
                const card = document.createElement("div");
                card.className =
                    "card bg-base-100/50 backdrop-blur-sm border border-base-content/5 hover:border-primary/30 hover:shadow-lg hover:shadow-primary/5 transition-all duration-300 group";
                card.innerHTML = `
            <div class="card-body p-6">
               <div class="flex justify-between items-start">
                   <div class="flex-1">
                       <div class="flex items-center gap-3 mb-2">
                           <h2 class="text-lg font-bold text-base-content">${key.name}</h2>
                           <div class="badge badge-sm badge-outline opacity-40 border-base-content/20 font-mono uppercase text-[10px] tracking-tighter px-1.5">${key.provider || "openai"}</div>
                           ${statusBadge}
                       </div>
                       <code class="text-xs text-base-content/40 bg-base-content/5 px-2 py-1 rounded font-mono">${key.prefix}</code>
                   </div>
                   <div class="flex flex-col items-end gap-2">
                       ${modeBadge}
                   </div>
               </div>
               
               <div class="grid grid-cols-3 gap-4 mt-6 pt-4 border-t border-base-content/5">
                   <div>
                       <div class="text-xs text-base-content/50 mb-1">Budget</div>
                       <div class="font-mono font-medium text-sm">$${usage.toFixed(2)} <span class="text-base-content/40">/ ${limit > 0 ? "$" + limit.toFixed(0) : "âˆž"}</span></div>
                       <div class="w-full h-1.5 bg-base-content/10 rounded-full mt-2 overflow-hidden">
                           <div class="${barColor} h-full rounded-full transition-all" style="width: ${usagePercent}%"></div>
                       </div>
                   </div>
                   <div>
                       <div class="text-xs text-base-content/50 mb-1">Rate Limit</div>
                       <div class="font-mono font-medium text-sm">${rateLimitText}</div>
                   </div>
                   <div class="text-right">
                       <div class="text-xs text-base-content/50 mb-1">Expires</div>
                       <div class="font-medium text-sm ${isExpired ? "text-error" : ""}">${expiresText}</div>
                   </div>
               </div>

               <div class="flex justify-between items-center mt-6 pt-4 border-t border-base-content/5">
                   <span class="text-xs text-base-content/40">Created ${new Date(key.created_at * 1000).toLocaleDateString()}</span>
                   <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                       <button class="btn btn-sm btn-ghost text-base-content/60 hover:text-base-content" onclick="openEdit(${key.id})">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                           Edit
                       </button>
                       <button class="btn btn-sm btn-ghost text-error/60 hover:text-error hover:bg-error/10" onclick="revokeKey(${key.id})">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                           Revoke
                       </button>
                   </div>
               </div>
            </div>
          `;
                grid?.appendChild(card);
            });
        } catch (err) {
            console.error(err);
        }
    }

    // --- Actions ---
    (window as any).copyKey = () => {
        const el = document.getElementById("new-key-value");
        if (el) navigator.clipboard.writeText(el.innerText);
    };

    (window as any).revokeKey = async (id: number) => {
        if (!confirm("Are you sure? This cannot be undone.")) return;
        await fetch(`/v1/config/app-keys/${id}`, { method: "DELETE" });
        loadKeys();
    };

    (window as any).openEdit = (id: number) => {
        const key = currentKeys.find((k) => k.id === id);
        if (!key) return;

        (document.getElementById("edit-key-id") as HTMLInputElement).value =
            id.toString();
        (document.getElementById("edit-key-name") as HTMLInputElement).value =
            key.name;
        (document.getElementById("edit-key-limit") as HTMLInputElement).value =
            key.budget_limit.toString();
        (
            document.getElementById("edit-key-is-mock") as HTMLInputElement
        ).checked = key.is_mock;
        (
            document.getElementById(
                "edit-key-mock-config",
            ) as HTMLTextAreaElement
        ).value = key.mock_config || '{"choices":[]}';
        (
            document.getElementById("edit-key-rate-limit") as HTMLInputElement
        ).value = (key.rate_limit || 10).toString();
        (
            document.getElementById("edit-key-provider") as HTMLSelectElement
        ).value = key.provider || "openai";
        (
            document.getElementById("edit-key-rate-period") as HTMLSelectElement
        ).value = key.rate_period || "minute";

        (window as any).toggleEditMock();

        (
            document.getElementById("edit-key-modal") as HTMLInputElement
        ).checked = true;
    };

    // CREATE
    const createForm = document.getElementById("create-key-form");
    createForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(createForm as HTMLFormElement);

        const mode = fd.get("mode_type");
        const days = parseInt(fd.get("expiration") as string);
        let expires_at: number | null = null;
        let period = "none";

        if (mode === "prepaid") {
            if (days > 0)
                expires_at = Math.floor(Date.now() / 1000) + days * 86400;
        } else {
            period = fd.get("budget_period") as string;
        }

        const payload = {
            name: fd.get("name"),
            provider: fd.get("provider") || "openai",
            expires_at,
            budget_limit: parseFloat(fd.get("budget_limit") as string),
            budget_period: period,
            is_mock: (
                document.getElementById("mock-toggle") as HTMLInputElement
            ).checked,
            mock_config: fd.get("mock_config"),
            rate_limit: parseInt(fd.get("rate_limit") as string) || 10,
            rate_period: fd.get("rate_period") || "minute",
        };

        const res = await fetch("/v1/config/app-keys", {
            method: "POST",
            body: JSON.stringify(payload),
            headers: { "Content-Type": "application/json" },
        });

        if (res.ok) {
            const data = await res.json();
            (
                document.getElementById("create-key-modal") as HTMLInputElement
            ).checked = false;
            (
                document.getElementById("new-key-value") as HTMLElement
            ).innerText = data.key;
            (
                document.getElementById(
                    "new-key-display-modal",
                ) as HTMLInputElement
            ).checked = true;
        } else {
            alert("Failed to create key");
        }
    });

    // UPDATE
    const editForm = document.getElementById("edit-key-form");
    editForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = (document.getElementById("edit-key-id") as HTMLInputElement)
            .value;

        const payload = {
            name: (document.getElementById("edit-key-name") as HTMLInputElement)
                .value,
            provider:
                (
                    document.getElementById(
                        "edit-key-provider",
                    ) as HTMLSelectElement
                ).value || "openai",
            budget_limit: parseFloat(
                (document.getElementById("edit-key-limit") as HTMLInputElement)
                    .value,
            ),
            is_mock: (
                document.getElementById("edit-key-is-mock") as HTMLInputElement
            ).checked,
            mock_config: (
                document.getElementById(
                    "edit-key-mock-config",
                ) as HTMLTextAreaElement
            ).value,
            rate_limit:
                parseInt(
                    (
                        document.getElementById(
                            "edit-key-rate-limit",
                        ) as HTMLInputElement
                    ).value,
                ) || 10,
            rate_period:
                (
                    document.getElementById(
                        "edit-key-rate-period",
                    ) as HTMLSelectElement
                ).value || "minute",
        };

        const res = await fetch(`/v1/config/app-keys/${id}`, {
            method: "PUT",
            body: JSON.stringify(payload),
            headers: { "Content-Type": "application/json" },
        });

        if (res.ok) {
            (
                document.getElementById("edit-key-modal") as HTMLInputElement
            ).checked = false;
            loadKeys();
        } else {
            alert("Failed to update key");
        }
    });

    loadKeys();
</script>
